<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
        // Import http://stuk.github.io/jszip/ for zip files:
    <script language="javascript" src="lib/jszip/dist/jszip.js"></script>
        // Import https://github.com/eligrey/FileSaver.js for downloading files:
    <script language="javascript" src="lib/filesaver/src/FileSaver.js"></script>
		// The transformation from BPMN to SpecIF:
    <script language="javascript" src="js/BPMN2Specif.js"></script>

    <script>
        // Einlesen der XML Datei
        function readFile() {
            var xmlFile = document.getElementById("XML").files[0];
			var opts = {};
			opts.fileName = xmlFile.name;
			opts.title = prompt("Bitte geben Sie einen Projektnamen ein", "DefaultTitle");
			opts.description = prompt("Bitte geben Sie eine Projektbeschreibung ein", "DefaultDescription");
			opts.svgFile = document.getElementById("SVG").files[0];
			opts.fileDate = new Date();
            opts.fileDate = opts.fileDate.toISOString();

            var reader = new FileReader();
            reader.readAsText(xmlFile);
            reader.onloadend = function() {
                var xmlString = reader.result;
                document.getElementById("output").innerHTML = reader.result;
				
				// transform to SpecIF:
                var model = BPMN2Specif( xmlString, opts );
				// ... and store as ZIP:
				var myJSON = JSON.stringify(model);
				var myBeautyJSON = JSON.stringify(model, null, "\t");
				document.getElementById("output").innerHTML = document.getElementById("output").innerHTML + myBeautyJSON;;
				zipCreator(myJSON, opts.svgFile, opts.title)
            }
        }

		// Store the .specifz file locally:
		function zipCreator(json, svg, title) {
			var zip = new JSZip();
			zip.file("BPMN.specif", json);
			zip.file("BusinessProcess.svg", svg);
			zip.generateAsync({
					type: "blob"
				})
				.then(function(blob) {
					saveAs(blob, title + ".specifz");
				});
		}
    </script>
</head>

<body>

    <h2>BPMN 2.0 to SpecIF Prototype</h2>

    <p>BPMN Grafik
        <input type="file" id="SVG">

        <p>BPMN XML
            <input type="file" id="XML"></p>

        <p>Output:</p>
        <textarea id="output" name="text" cols="180" rows="20"></textarea>

        <p>
            <button type="button" onclick="readFile()">BPMN Dateien in .specifz umwandeln</button>
        </p>

</body>

</html>