<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <!-- Import http://stuk.github.io/jszip/ for zip files: -->
    <script language="javascript" src="lib/jszip/dist/jszip.js"></script>
    <!-- Import https://github.com/eligrey/FileSaver.js for downloading files: -->
    <script language="javascript" src="lib/filesaver/src/FileSaver.js"></script>
	<!-- The transformation from BPMN to SpecIF: -->
    <script language="javascript" src="js/BPMN2Specif.js"></script>

    <script>
        // Read the files, transform BPMN to SpecIF and store locally as ZIP:
        function readFile() {
            var xmlFile = document.getElementById("XML").files[0],
				svgFile = document.getElementById("SVG").files[0];
			var opts = {};
			opts.xmlName = xmlFile.name;
			opts.title = prompt("Bitte geben Sie einen Projektnamen ein", "DefaultTitle");
			opts.description = prompt("Bitte geben Sie eine Projektbeschreibung ein", "DefaultDescription");
			opts.xmlDate = new Date();
            opts.xmlDate = opts.xmlDate.toISOString();
			opts.svgName = svgFile? svgFile.name : null;

            let reader = new FileReader();
			reader.addEventListener('loadend', createSpecifz );
            reader.readAsText(xmlFile);
			return

			// Store the .specifz file locally:
			function createSpecifz(ev) {
				let bpmnXml = ev.target.result;
				document.getElementById("input").innerHTML = bpmnXml;
				
				// transform to SpecIF:
				let model = BPMN2Specif( bpmnXml, opts );
				// here, we supply the files separately:
				model.files.forEach( function(f) {
					if(f.blob) delete f.blob
				});
				//  store as ZIP:
				let myJSON = JSON.stringify(model),
					myBeautyJSON = JSON.stringify(model, null, "\t");
				document.getElementById("output").innerHTML = myBeautyJSON;

				let zip = new JSZip();
				zip.file( opts.xmlName, xmlFile );
				zip.file( opts.title+".specif", myJSON);
				if( svgFile )
					zip.file( opts.svgName, svgFile );
				
				zip.generateAsync({
					type: "blob"
				})
				.then(function(blob) {
					saveAs(blob, opts.title+".specifz")
				})
			}
		}
    </script>
</head>

<body>

    <h2>BPMN 2.0 to SpecIF Transformation</h2>

    <p>BPMN Grafik
        <input type="file" id="SVG">
	</p>

	<p>BPMN XML
		<input type="file" id="XML">
	</p>

	<p>
		<button type="button" onclick="readFile()">BPMN Dateien in .specifz umwandeln</button>
	</p>

	<p>Input:</p>
	<textarea id="input" name="text" cols="180" rows="20"></textarea>

	<p>Output:</p>
	<textarea id="output" name="text" cols="180" rows="20"></textarea>

</body>

</html>